name: Deploy

on:
  workflow_run:
    workflows: ["Test"] # Matches the 'name' of test.yml
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  # Check if any non-documentation files were changed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 2

      - name: Check for code changes
        id: filter
        run: |
          # Get list of changed files in the last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          # Check if any non-documentation files changed
          if echo "$CHANGED_FILES" | grep -qvE '\.(md)$|^docs/|^LICENSE|^CONTRIBUTING\.md|^\.gitignore$'; then
            echo "code=true" >> $GITHUB_OUTPUT
            echo "Code files changed, deployment needed"
          else
            echo "code=false" >> $GITHUB_OUTPUT
            echo "Only documentation changed, skipping deployment"
          fi

  deploy:
    runs-on: self-hosted
    needs: check-changes
    # Only run if test workflow succeeded AND code files changed
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      needs.check-changes.outputs.should-deploy == 'true'
    steps:
      # Checkout the specific commit that triggered the successful test workflow
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: pull # This step might be redundant now if checkout handles it, but keeping for consistency with original logic
        working-directory: /www/image-splitter/
        run: git reset --hard && git pull

      - name: restart
        working-directory: /www/image-splitter/
        run: chmod +x restart.sh && ./restart.sh
